<!DOCTYPE html>
<html lang="fa">
  <head>
    <meta charset="UTF-8" />
    <title>Ÿæÿ±ÿØÿßÿ≤ÿ¥ JSON Ÿæ€åÿ¥ÿ±ŸÅÿ™Ÿá</title>
    <link rel="icon" type="image/x-icon" href="../favicon.ico" />
    <link
      href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />

    <!-- js-beautify library with fallback -->
    <script>
      // Function to load js-beautify with fallback CDNs
      function loadJsBeautify() {
        const cdns = [
          "https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.9/beautify.min.js",
          "https://unpkg.com/js-beautify@1.14.9/js/lib/beautify.min.js",
          "https://cdn.jsdelivr.net/npm/js-beautify@1.14.9/js/lib/beautify.min.js",
        ];

        let currentCdnIndex = 0;

        function tryLoadScript() {
          if (currentCdnIndex >= cdns.length) {
            console.error("‚ùå Failed to load js-beautify from all CDNs");
            return;
          }

          const script = document.createElement("script");
          script.src = cdns[currentCdnIndex];

          script.onload = function () {
            console.log(
              `‚úÖ js-beautify loaded successfully from: ${cdns[currentCdnIndex]}`
            );
            // Test the library
            setTimeout(() => {
              const testFunc = getBeautifyFunction();
              if (testFunc) {
                console.log("üéâ js-beautify is ready to use!");
              }
            }, 100);
          };

          script.onerror = function () {
            console.warn(
              `‚ö†Ô∏è Failed to load js-beautify from: ${cdns[currentCdnIndex]}`
            );
            currentCdnIndex++;
            tryLoadScript();
          };

          document.head.appendChild(script);
        }

        tryLoadScript();
      }

      // Start loading immediately
      loadJsBeautify();
    </script>
    <style>
      :root {
        --vscode-foreground: var(--vscode-editor-foreground, #e1e4e8);
        --vscode-background: var(--vscode-editor-background, #1e1e1e);
        --vscode-button-background: var(--vscode-button-background, #0078d4);
        --vscode-button-foreground: var(--vscode-button-foreground, #ffffff);
        --vscode-input-background: var(--vscode-input-background, #2d2d30);
        --vscode-input-border: var(--vscode-input-border, #464647);
        --vscode-panel-background: var(--vscode-panel-background, #252526);
        --card-header-bg: #1f1f23;
        --border-color: #464647;
        --success-color: #28a745;
        --error-color: #dc3545;
        --warning-color: #ffc107;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Vazirmatn", "Segoe UI", Tahoma, Arial, sans-serif;
        padding: 16px;
        background: var(--vscode-background);
        color: var(--vscode-foreground);
        direction: ltr;
        overflow-x: hidden;
      }

      .container {
        max-width: 1600px;
        margin: 0 auto;
        height: calc(100vh - 32px);
        display: flex;
        flex-direction: column;
        overflow: visible;
      }

      .header {
        text-align: center;
        margin-bottom: 20px;
        padding: 16px;
        background: linear-gradient(
          135deg,
          var(--vscode-panel-background),
          var(--card-header-bg)
        );
        border-radius: 12px;
        border: 1px solid var(--border-color);
      }

      .header h1 {
        color: var(--vscode-button-background);
        font-size: 1.8em;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .header-subtitle {
        color: var(--vscode-foreground);
        opacity: 0.7;
        font-size: 0.9em;
      }

      .json-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        flex: 1;
        min-height: 0;
      }

      .json-card {
        background: linear-gradient(
          135deg,
          var(--vscode-panel-background),
          var(--card-header-bg)
        );
        border: 1px solid var(--border-color);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        overflow: visible; /* Changed from hidden to visible */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
      }

      .json-card:hover {
        box-shadow: 0 8px 25px rgba(0, 120, 212, 0.2);
        transform: translateY(-2px);
      }

      .card-header {
        background: var(--card-header-bg);
        border-bottom: 1px solid var(--border-color);
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-height: 56px;
        border-radius: 10px 10px 0 0;
      }

      .card-title {
        font-weight: 600;
        font-size: 1em;
        color: var(--vscode-foreground);
      }

      .toolbar {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .icon-btn {
        background: none;
        border: none;
        color: #e1e4e8;
        cursor: pointer;
        padding: 6px;
        border-radius: 6px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }

      .icon-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: scale(1.1);
      }

      .icon-btn.active {
        background: var(--vscode-button-background);
        color: white;
      }

      .search-input {
        background: var(--vscode-input-background);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 6px 12px;
        color: var(--vscode-foreground);
        font-family: inherit;
        font-size: 0.9em;
        width: 200px;
        transition: all 0.2s ease;
      }

      .search-input:focus {
        outline: none;
        border-color: var(--vscode-button-background);
        box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
      }

      .card-content {
        flex: 1;
        padding: 16px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .json-textarea {
        width: 100%;
        height: 100%;
        background: var(--vscode-input-background);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
        color: var(--vscode-foreground);
        font-family: "Courier New", monospace;
        font-size: 13px;
        line-height: 1.5;
        resize: none;
        overflow-y: auto;
        transition: all 0.2s ease;
      }

      .json-textarea:focus {
        outline: none;
        border-color: var(--vscode-button-background);
        box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
      }

      .json-viewer {
        width: 100%;
        height: 100%;
        background: var(--vscode-input-background);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 13px;
        line-height: 1.5;
      }

      .json-tree {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .json-node {
        margin: 2px 0;
      }

      .json-key {
        color: #9cdcfe;
        font-weight: 500;
        cursor: pointer;
        position: relative;
        padding: 2px 4px;
        border-radius: 3px;
        transition: all 0.2s ease;
      }

      .json-key:hover {
        background: rgba(156, 220, 254, 0.1);
      }

      .json-string {
        color: #ce9178;
        cursor: pointer;
        position: relative;
        padding: 2px 4px;
        border-radius: 3px;
        transition: all 0.2s ease;
      }

      .json-string:hover {
        background: rgba(206, 145, 120, 0.1);
      }

      .json-number {
        color: #b5cea8;
        cursor: pointer;
        position: relative;
        padding: 2px 4px;
        border-radius: 3px;
        transition: all 0.2s ease;
      }

      .json-number:hover {
        background: rgba(181, 206, 168, 0.1);
      }

      .json-boolean {
        color: #569cd6;
        cursor: pointer;
        position: relative;
        padding: 2px 4px;
        border-radius: 3px;
        transition: all 0.2s ease;
      }

      .json-boolean:hover {
        background: rgba(86, 156, 214, 0.1);
      }

      .json-value-container {
        display: inline-block;
        position: relative;
      }

      .json-actions {
        position: absolute;
        top: -25px;
        right: 0;
        background: var(--vscode-panel-background);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 4px;
        display: none;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      .json-actions.show {
        display: flex;
        gap: 4px;
      }

      .json-action-btn {
        background: none;
        border: none;
        color: var(--vscode-foreground);
        cursor: pointer;
        padding: 2px 4px;
        border-radius: 2px;
        font-size: 10px;
        transition: all 0.2s ease;
      }

      .json-action-btn:hover {
        background: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
      }

      .json-edit-input {
        background: var(--vscode-input-background);
        border: 1px solid var(--vscode-button-background);
        border-radius: 3px;
        padding: 2px 4px;
        color: var(--vscode-foreground);
        font-family: inherit;
        font-size: inherit;
        min-width: 50px;
      }

      .json-edit-input:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.3);
      }

      .json-null {
        color: #808080;
      }

      .json-punctuation {
        color: #d4d4d4;
      }

      .toggle-btn {
        background: none;
        border: none;
        color: #d4d4d4;
        cursor: pointer;
        margin-left: 4px;
        font-size: 16px;
        width: 20px;
        height: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 3px;
        transition: all 0.2s ease;
        font-family: "Material Icons";
      }

      .toggle-btn:hover {
        background-color: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
        transform: scale(1.1);
      }

      .toggle-btn:active {
        transform: scale(0.95);
      }

      .collapsible {
        display: none;
      }

      .status-bar {
        background: var(--card-header-bg);
        border-top: 1px solid var(--border-color);
        padding: 8px 16px;
        font-size: 0.85em;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 0 0 10px 10px;
      }

      .status-valid {
        color: var(--success-color);
      }

      .status-invalid {
        color: var(--error-color);
      }

      .status-info {
        color: var(--vscode-foreground);
        opacity: 0.7;
      }

      .file-input {
        display: none;
      }

      .tooltip {
        position: relative;
      }

      .tooltip::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 150%;
        left: 50%;
        transform: translateX(-50%);
        background: #1a1a1a;
        color: #ffffff;
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        z-index: 999999;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
        border: 1px solid #404040;
        pointer-events: none;
        font-family: "Vazirmatn";
      }

      .tooltip::before {
        content: "";
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 8px solid #1a1a1a;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        z-index: 999999;
        pointer-events: none;
      }

      .tooltip:hover::after,
      .tooltip:hover::before {
        opacity: 1;
        visibility: visible;
      }

      @media (max-width: 768px) {
        .json-grid {
          grid-template-columns: 1fr;
          gap: 16px;
        }

        .search-input {
          width: 120px;
        }

        .toolbar {
          gap: 4px;
        }
      }

      /* Highlight search results */
      .highlight {
        background: #ffc107;
        color: #000;
        padding: 1px 2px;
        border-radius: 2px;
      }

      /* Animation for card loading */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .json-card {
        animation: fadeInUp 0.5s ease-out;
      }

      .json-card:nth-child(2) {
        animation-delay: 0.1s;
      }

      /* Paste notice banner */
      .paste-notice {
        background: rgba(0, 120, 212, 0.1);
        border: 1px solid var(--vscode-button-background);
        border-radius: 6px;
        padding: 8px 12px;
        margin: 0 0 16px 0;
        font-size: 0.85em;
        text-align: right;
        direction: rtl;
        color: var(--vscode-button-background);
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>
          <span
            class="material-icons"
            style="vertical-align: middle; margin-right: 8px"
            >code</span
          >Ÿæÿ±ÿØÿßÿ≤ÿ¥ JSON Ÿæ€åÿ¥ÿ±ŸÅÿ™Ÿá
        </h1>
        <div class="header-subtitle">
          ÿ™ÿ≠ŸÑ€åŸÑÿå ŸÅÿ±ŸÖÿ™ Ÿà Ÿà€åÿ±ÿß€åÿ¥ ÿØÿßÿØŸá‚ÄåŸáÿß€å JSON ÿ®ÿß ÿßŸÖ⁄©ÿßŸÜÿßÿ™ Ÿæ€åÿ¥ÿ±ŸÅÿ™Ÿá
        </div>
      </div>

      <div class="json-grid">
        <!-- Input Panel (moved to right) -->
        <div class="json-card">
          <div class="card-header">
            <div class="card-title">
              <span
                class="material-icons"
                style="
                  vertical-align: middle;
                  margin-right: 8px;
                  font-size: 18px;
                "
                >edit</span
              >
              Ÿà€åÿ±ÿß€åÿ¥⁄Øÿ± JSON
            </div>
            <div class="toolbar">
              <input
                type="file"
                id="fileInput"
                class="file-input"
                accept=".json"
                onchange="importFile()"
              />
              <button
                class="icon-btn tooltip"
                data-tooltip="ÿß€åŸÖŸæŸàÿ±ÿ™ ŸÅÿß€åŸÑ"
                onclick="document.getElementById('fileInput').click()"
              >
                <span class="material-icons">file_upload</span>
              </button>
              <button
                class="icon-btn tooltip"
                data-tooltip="Ÿæÿß⁄© ⁄©ÿ±ÿØŸÜ"
                onclick="clearInput()"
              >
                <span class="material-icons">clear</span>
              </button>
              <button
                class="icon-btn tooltip"
                data-tooltip="ŸÜŸÖŸàŸÜŸá JSON"
                onclick="loadSample()"
              >
                <span class="material-icons">dataset</span>
              </button>
            </div>
          </div>
          <div class="card-content">
            <textarea
              id="inputJson"
              class="json-textarea"
              placeholder='€å⁄© JSON ŸÖÿπÿ™ÿ®ÿ± Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØÿå ŸÖÿ´ÿßŸÑ:
{
  "name": "ÿßÿ≠ŸÖÿØ ÿ±ÿ∂ÿß€å€å",
  "age": 25,
  "city": "ÿ™Ÿáÿ±ÿßŸÜ",
  "skills": ["JavaScript", "Python", "React"]
}'
              oninput="processJson()"
              onpaste="setTimeout(processJson, 10)"
            ></textarea>
          </div>
          <div class="status-bar">
            <span id="inputStatus" class="status-info"
              >ÿ¢ŸÖÿßÿØŸá ÿØÿ±€åÿßŸÅÿ™ JSON...</span
            >
            <span id="inputLength" class="status-info">0 ⁄©ÿßÿ±ÿß⁄©ÿ™ÿ±</span>
          </div>
        </div>

        <!-- Output Panel (moved to left) -->
        <div class="json-card">
          <div class="card-header">
            <div class="card-title">
              <span
                class="material-icons"
                style="
                  vertical-align: middle;
                  margin-right: 8px;
                  font-size: 18px;
                "
                >visibility</span
              >
              ŸÜŸÖÿß€åÿ¥⁄Øÿ± JSON
            </div>
            <div class="toolbar">
              <input
                type="text"
                id="searchInput"
                class="search-input"
                placeholder="ÿ¨ÿ≥ÿ™ÿ¨Ÿà..."
                onkeyup="searchInJson()"
              />
              <button
                class="icon-btn tooltip active"
                data-tooltip="ŸÜŸÖÿß€å ÿØÿ±ÿÆÿ™€å"
                id="treeViewBtn"
                onclick="toggleView('tree')"
              >
                <span class="material-icons">account_tree</span>
              </button>
              <button
                class="icon-btn tooltip"
                data-tooltip="ŸÜŸÖÿß€å ŸÖÿ™ŸÜ€å"
                id="textViewBtn"
                onclick="toggleView('text')"
              >
                <span class="material-icons">description</span>
              </button>
              <button
                class="icon-btn tooltip"
                data-tooltip="⁄©Ÿæ€å"
                onclick="copyOutput()"
              >
                <span class="material-icons">content_copy</span>
              </button>
              <button
                class="icon-btn tooltip"
                data-tooltip="ÿØÿßŸÜŸÑŸàÿØ"
                onclick="downloadJson()"
              >
                <span class="material-icons">file_download</span>
              </button>
            </div>
          </div>
          <div class="card-content">
            <textarea
              id="outputJson"
              class="json-textarea"
              readonly
              style="display: none"
            ></textarea>
            <div
              id="jsonViewer"
              class="json-viewer"
              style="display: block"
            ></div>
          </div>
          <div class="status-bar">
            <span id="outputStatus" class="status-info">ÿ¢ŸÖÿßÿØŸá ŸÜŸÖÿß€åÿ¥...</span>
            <span id="jsonInfo" class="status-info"></span>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentView = "tree"; // Default to tree view
      let jsonData = null;
      let searchTerm = "";

      // Helper function to save JSON to localStorage
      function saveJsonToStorage(jsonContent) {
        try {
          localStorage.setItem("vscode-persian-copilot-json", jsonContent);
          console.log("üíæ JSON saved to localStorage");
        } catch (e) {
          console.error("‚ùå Failed to save JSON to localStorage:", e);
        }
      }

      // Helper function to load JSON from localStorage
      function loadJsonFromStorage() {
        try {
          const saved = localStorage.getItem("vscode-persian-copilot-json");
          if (saved) {
            console.log("üì• JSON loaded from localStorage");
            return saved;
          }
        } catch (e) {
          console.error("‚ùå Failed to load JSON from localStorage:", e);
        }
        return null;
      }

      // Enhanced helper function to get js-beautify function
      function getBeautifyFunction() {
        // Check different possible global names for js-beautify
        const possibleNames = [
          "js_beautify",
          "beautify",
          "jsBeautify",
          "window.js_beautify",
          "window.beautify",
          "window.jsBeautify",
        ];

        for (const name of possibleNames) {
          try {
            let func;
            if (name.startsWith("window.")) {
              const propName = name.split(".")[1];
              func = window[propName];
            } else {
              func = eval(
                `typeof ${name} !== 'undefined' ? ${name} : undefined`
              );
            }

            if (typeof func === "function") {
              console.log(`üéØ Found js-beautify as: ${name}`);
              return func;
            }
          } catch (e) {
            // Continue to next possibility
          }
        }

        console.warn("‚ö†Ô∏è js-beautify function not found");
        return null;
      }

      // Helper function to beautify JSON with js-beautify
      function beautifyJson(jsonData) {
        const beautifyFunction = getBeautifyFunction();

        if (beautifyFunction) {
          try {
            const beautifyOptions = {
              indent_size: 2,
              indent_char: " ",
              max_preserve_newlines: 2,
              preserve_newlines: true,
              keep_array_indentation: false,
              break_chained_methods: false,
              indent_scripts: "normal",
              brace_style: "collapse",
              space_before_conditional: true,
              unescape_strings: false,
              jslint_happy: false,
              end_with_newline: false,
              wrap_line_length: 0,
              indent_inner_html: false,
              comma_first: false,
              e4x: false,
              indent_empty_lines: false,
            };

            const jsonString = JSON.stringify(jsonData);
            const formatted = beautifyFunction(jsonString, beautifyOptions);
            console.log("‚úÖ JSON formatted using js-beautify");
            return formatted;
          } catch (e) {
            console.error("‚ùå js-beautify error:", e);
          }
        } else {
          console.warn(
            "‚ö†Ô∏è js-beautify not found, using JSON.stringify fallback"
          );
        }

        // Fallback to regular JSON.stringify
        return JSON.stringify(jsonData, null, 2);
      }

      // Process JSON input
      function processJson() {
        const inputEl = document.getElementById("inputJson");
        const inputStatus = document.getElementById("inputStatus");
        const inputLength = document.getElementById("inputLength");
        const outputStatus = document.getElementById("outputStatus");
        const jsonInfo = document.getElementById("jsonInfo");

        if (!inputEl) return;
        const input = inputEl.value;

        if (inputLength) inputLength.textContent = `${input.length} ⁄©ÿßÿ±ÿß⁄©ÿ™ÿ±`;

        if (!input.trim()) {
          if (inputStatus) {
            inputStatus.textContent = "ÿ¢ŸÖÿßÿØŸá ÿØÿ±€åÿßŸÅÿ™ JSON...";
            inputStatus.className = "status-info";
          }
          clearOutput();
          return;
        }

        try {
          jsonData = JSON.parse(input);

          // Save the valid JSON to localStorage
          saveJsonToStorage(input);

          if (inputStatus) {
            inputStatus.textContent = "JSON ŸÖÿπÿ™ÿ®ÿ± ‚úì";
            inputStatus.className = "status-valid";
          }

          if (currentView === "text") {
            updateTextView();
          } else {
            updateTreeView();
          }

          // Enhanced statistics using js-beautify
          const stats = getJsonStatistics(jsonData);
          if (jsonInfo) {
            jsonInfo.innerHTML = `
                        <strong>üìä ÿ¢ŸÖÿßÿ±:</strong><br>
                        ⁄©ŸÑ€åÿØŸáÿß: ${stats.keys.toLocaleString("fa-IR")} | 
                        ÿ¢ÿ±ÿß€åŸá‚ÄåŸáÿß: ${stats.arrays.toLocaleString("fa-IR")} | 
                        ÿßÿ¥€åÿßÿ°: ${stats.objects.toLocaleString("fa-IR")} | 
                        ÿπŸÖŸÇ: ${stats.depth.toLocaleString("fa-IR")} ÿ≥ÿ∑ÿ≠
                    `;
          }
          if (outputStatus) {
            outputStatus.textContent = "ŸÜŸÖÿß€åÿ¥ ŸÖŸàŸÅŸÇ ‚úì";
            outputStatus.className = "status-valid";
          }
        } catch (error) {
          jsonData = null; // Clear jsonData on error
          if (inputStatus) {
            inputStatus.textContent = `ÿÆÿ∑ÿß: ${error.message}`;
            inputStatus.className = "status-invalid";
          }
          if (outputStatus) {
            outputStatus.textContent = "ÿÆÿ∑ÿß ÿØÿ± Ÿæÿ±ÿØÿßÿ≤ÿ¥";
            outputStatus.className = "status-invalid";
          }
          if (jsonInfo) jsonInfo.textContent = "";
          clearOutput();
        }
      }

      // Enhanced text view using js-beautify
      function updateTextView() {
        const output = document.getElementById("outputJson");
        if (!output || !jsonData) return;

        const formatted = beautifyJson(jsonData);

        if (searchTerm) {
          const highlighted = highlightSearch(formatted, searchTerm);
          output.innerHTML = highlighted;
        } else {
          output.value = formatted;
        }
      }

      // Update tree view
      function updateTreeView() {
        const viewer = document.getElementById("jsonViewer");
        if (!viewer || !jsonData) return;
        viewer.innerHTML = renderJsonTree(jsonData, searchTerm);
      }

      // Render JSON as interactive tree
      function renderJsonTree(obj, search = "", level = 0, path = "") {
        if (obj === null)
          return `<span class="json-null" onclick="showValueActions(this, 'null', '${path}')">null</span>`;

        if (typeof obj === "string") {
          const escapedPath = path.replace(/'/g, "\\'");
          let content = `"${obj}"`;
          if (search && obj.toLowerCase().includes(search.toLowerCase())) {
            content = highlightSearch(content, search);
          }
          return `<span class="json-value-container">
                    <span class="json-string" onclick="showValueActions(this, 'string', '${escapedPath}')">${content}</span>
                    <div class="json-actions">
                        <button class="json-action-btn" onclick="copyValue('${escapedPath}')">üìã</button>
                        <button class="json-action-btn" onclick="editValue(this, '${escapedPath}', 'string')">‚úèÔ∏è</button>
                    </div>
                </span>`;
        }

        if (typeof obj === "number") {
          const escapedPath = path.replace(/'/g, "\\'");
          return `<span class="json-value-container">
                    <span class="json-number" onclick="showValueActions(this, 'number', '${escapedPath}')">${obj}</span>
                    <div class="json-actions">
                        <button class="json-action-btn" onclick="copyValue('${escapedPath}')">üìã</button>
                        <button class="json-action-btn" onclick="editValue(this, '${escapedPath}', 'number')">‚úèÔ∏è</button>
                    </div>
                </span>`;
        }

        if (typeof obj === "boolean") {
          const escapedPath = path.replace(/'/g, "\\'");
          return `<span class="json-value-container">
                    <span class="json-boolean" onclick="showValueActions(this, 'boolean', '${escapedPath}')">${obj}</span>
                    <div class="json-actions">
                        <button class="json-action-btn" onclick="copyValue('${escapedPath}')">üìã</button>
                        <button class="json-action-btn" onclick="editValue(this, '${escapedPath}', 'boolean')">‚úèÔ∏è</button>
                    </div>
                </span>`;
        }

        if (Array.isArray(obj)) {
          if (obj.length === 0)
            return '<span class="json-punctuation">[]</span>';

          const isCollapsible = obj.length > 5 || level > 2;
          const toggleId = "toggle_" + Math.random().toString(36).substr(2, 9);

          let html = "";
          if (isCollapsible) {
            html += `<button class="toggle-btn" onclick="toggleCollapse('${toggleId}')">expand_more</button>`;
          }
          html += '<span class="json-punctuation">[</span>\n';

          const contentClass = isCollapsible ? "collapsible" : "";
          html += `<div id="${toggleId}" class="${contentClass}">`;

          for (let i = 0; i < obj.length; i++) {
            html +=
              '<div class="json-node" style="margin-left: ' +
              (level + 1) * 20 +
              'px;">';
            html += renderJsonTree(obj[i], search, level + 1, `${path}[${i}]`);
            if (i < obj.length - 1)
              html += '<span class="json-punctuation">,</span>';
            html += "</div>";
          }

          html += "</div>";
          html +=
            '<div style="margin-left: ' +
            level * 20 +
            'px;"><span class="json-punctuation">]</span></div>';
          return html;
        }

        if (typeof obj === "object") {
          const keys = Object.keys(obj);
          if (keys.length === 0)
            return '<span class="json-punctuation">{}</span>';

          const isCollapsible = keys.length > 3 || level > 2;
          const toggleId = "toggle_" + Math.random().toString(36).substr(2, 9);

          let html = "";
          if (isCollapsible) {
            html += `<button class="toggle-btn" onclick="toggleCollapse('${toggleId}')">expand_more</button>`;
          }
          html += '<span class="json-punctuation">{</span>\n';

          const contentClass = isCollapsible ? "collapsible" : "";
          html += `<div id="${toggleId}" class="${contentClass}">`;

          for (let i = 0; i < keys.length; i++) {
            const key = keys[i];
            const currentPath = path ? `${path}.${key}` : key;
            const escapedPath = currentPath.replace(/'/g, "\\'");

            html +=
              '<div class="json-node" style="margin-left: ' +
              (level + 1) * 20 +
              'px;">';

            let keyContent = `"${key}"`;
            if (search && key.toLowerCase().includes(search.toLowerCase())) {
              keyContent = highlightSearch(keyContent, search);
            }

            html += `<span class="json-value-container">
                        <span class="json-key" onclick="showKeyActions(this, '${escapedPath}')">${keyContent}</span>
                        <div class="json-actions">
                            <button class="json-action-btn" onclick="copyKey('${escapedPath}')">üìã</button>
                            <button class="json-action-btn" onclick="copyPath('${escapedPath}')">üîó</button>
                        </div>
                    </span>`;
            html += '<span class="json-punctuation">: </span>';
            html += renderJsonTree(obj[key], search, level + 1, currentPath);
            if (i < keys.length - 1)
              html += '<span class="json-punctuation">,</span>';
            html += "</div>";
          }

          html += "</div>";
          html +=
            '<div style="margin-left: ' +
            level * 20 +
            'px;"><span class="json-punctuation">}</span></div>';
          return html;
        }

        return String(obj);
      }

      // Toggle view
      function toggleView(view) {
        currentView = view;
        const textBtn = document.getElementById("textViewBtn");
        const treeBtn = document.getElementById("treeViewBtn");
        const outputJson = document.getElementById("outputJson");
        const jsonViewer = document.getElementById("jsonViewer");

        if (!textBtn || !treeBtn || !outputJson || !jsonViewer) return;

        if (view === "text") {
          textBtn.classList.add("active");
          treeBtn.classList.remove("active");
          outputJson.style.display = "block";
          jsonViewer.style.display = "none";
          updateTextView();
        } else {
          treeBtn.classList.add("active");
          textBtn.classList.remove("active");
          outputJson.style.display = "none";
          jsonViewer.style.display = "block";
          updateTreeView();
        }
      }

      // Search in JSON
      function searchInJson() {
        const searchInput = document.getElementById("searchInput");
        if (!searchInput) return;

        searchTerm = searchInput.value;
        if (jsonData) {
          if (currentView === "text") {
            updateTextView();
          } else {
            updateTreeView();
          }
        }
      }

      // Highlight search terms
      function highlightSearch(text, term) {
        if (!term) return text;
        const regex = new RegExp(`(${term})`, "gi");
        return text.replace(regex, '<span class="highlight">$1</span>');
      }

      // Toggle collapse in tree view
      function toggleCollapse(id) {
        const element = document.getElementById(id);
        const button = element.previousElementSibling;

        if (
          element.style.display === "none" ||
          element.classList.contains("collapsible")
        ) {
          element.style.display = "block";
          element.classList.remove("collapsible");
          button.textContent = "expand_more";
        } else {
          element.style.display = "none";
          element.classList.add("collapsible");
          button.textContent = "chevron_right";
        }
      }

      // Enhanced JSON statistics function
      function getJsonStatistics(obj, depth = 0) {
        const stats = {
          keys: 0,
          arrays: 0,
          objects: 0,
          depth: depth,
          maxDepth: depth,
        };

        if (typeof obj === "object" && obj !== null) {
          if (Array.isArray(obj)) {
            stats.arrays = 1;
            obj.forEach((item) => {
              const childStats = getJsonStatistics(item, depth + 1);
              stats.keys += childStats.keys;
              stats.arrays += childStats.arrays;
              stats.objects += childStats.objects;
              stats.maxDepth = Math.max(stats.maxDepth, childStats.maxDepth);
            });
          } else {
            stats.objects = 1;
            const keys = Object.keys(obj);
            stats.keys += keys.length;

            keys.forEach((key) => {
              const childStats = getJsonStatistics(obj[key], depth + 1);
              stats.keys += childStats.keys;
              stats.arrays += childStats.arrays;
              stats.objects += childStats.objects;
              stats.maxDepth = Math.max(stats.maxDepth, childStats.maxDepth);
            });
          }
        }

        return {
          keys: stats.keys,
          arrays: stats.arrays,
          objects: stats.objects,
          depth: stats.maxDepth,
        };
      }

      // Interactive JSON actions
      function showValueActions(element, type, path) {
        // Hide all other actions first
        document
          .querySelectorAll(".json-actions")
          .forEach((el) => el.classList.remove("show"));

        const container = element.closest(".json-value-container");
        const actions = container.querySelector(".json-actions");
        actions.classList.add("show");

        // Hide after 3 seconds
        setTimeout(() => {
          actions.classList.remove("show");
        }, 3000);
      }

      function showKeyActions(element, path) {
        // Hide all other actions first
        document
          .querySelectorAll(".json-actions")
          .forEach((el) => el.classList.remove("show"));

        const container = element.closest(".json-value-container");
        const actions = container.querySelector(".json-actions");
        actions.classList.add("show");

        // Hide after 3 seconds
        setTimeout(() => {
          actions.classList.remove("show");
        }, 3000);
      }

      function getValueByPath(obj, path) {
        if (!path) return obj;
        return path
          .split(/[.\[\]]/)
          .filter(Boolean)
          .reduce((current, key) => {
            return current && current[key] !== undefined
              ? current[key]
              : undefined;
          }, obj);
      }

      function setValueByPath(obj, path, value) {
        if (!path) return;
        const keys = path.split(/[.\[\]]/).filter(Boolean);
        const lastKey = keys.pop();
        const target = keys.reduce((current, key) => current[key], obj);

        if (target && lastKey !== undefined) {
          target[lastKey] = value;
        }
      }

      function copyValue(path) {
        const value = getValueByPath(jsonData, path);
        let textToCopy;

        if (typeof value === "string") {
          textToCopy = value;
        } else {
          textToCopy = JSON.stringify(value, null, 2);
        }

        navigator.clipboard.writeText(textToCopy).then(() => {
          showNotification("ŸÖŸÇÿØÿßÿ± ⁄©Ÿæ€å ÿ¥ÿØ! üìã");
        });
      }

      function copyKey(path) {
        const keys = path.split(/[.\[\]]/).filter(Boolean);
        const key = keys[keys.length - 1];

        navigator.clipboard.writeText(key).then(() => {
          showNotification("⁄©ŸÑ€åÿØ ⁄©Ÿæ€å ÿ¥ÿØ! üîë");
        });
      }

      function copyPath(path) {
        navigator.clipboard.writeText(path).then(() => {
          showNotification("ŸÖÿ≥€åÿ± ⁄©Ÿæ€å ÿ¥ÿØ! üîó");
        });
      }

      function editValue(actionBtn, path, type) {
        const container = actionBtn.closest(".json-value-container");
        const valueElement = container.querySelector(`.json-${type}`);
        const currentValue = getValueByPath(jsonData, path);

        // Create input element
        const input = document.createElement("input");
        input.className = "json-edit-input";
        input.type = type === "number" ? "number" : "text";

        if (type === "string") {
          input.value = currentValue;
        } else if (type === "boolean") {
          input.type = "checkbox";
          input.checked = currentValue;
        } else {
          input.value = currentValue;
        }

        // Replace element with input
        valueElement.style.display = "none";
        container.insertBefore(input, valueElement);
        input.focus();

        // Handle save
        const saveEdit = () => {
          let newValue;

          if (type === "string") {
            newValue = input.value;
          } else if (type === "number") {
            newValue = parseFloat(input.value) || 0;
          } else if (type === "boolean") {
            newValue = input.checked;
          }

          // Update the JSON data
          setValueByPath(jsonData, path, newValue);

          // Remove input and show updated value
          input.remove();
          valueElement.style.display = "inline";

          // Update the display
          updateTreeView();
          updateTextView();

          showNotification("ŸÖŸÇÿØÿßÿ± Ÿà€åÿ±ÿß€åÿ¥ ÿ¥ÿØ! ‚úèÔ∏è");
        };

        // Handle cancel
        const cancelEdit = () => {
          input.remove();
          valueElement.style.display = "inline";
        };

        // Event listeners
        input.addEventListener("blur", saveEdit);
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            saveEdit();
          } else if (e.key === "Escape") {
            cancelEdit();
          }
        });
      }

      function showNotification(message) {
        // Create notification element
        const notification = document.createElement("div");
        notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--vscode-button-background);
                color: var(--vscode-button-foreground);
                padding: 12px 16px;
                border-radius: 6px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                animation: slideInRight 0.3s ease-out;
            `;
        notification.textContent = message;

        // Add animation styles
        const style = document.createElement("style");
        style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
        document.head.appendChild(style);

        document.body.appendChild(notification);

        // Remove after 2 seconds
        setTimeout(() => {
          notification.style.animation = "slideOutRight 0.3s ease-out";
          setTimeout(() => {
            notification.remove();
            style.remove();
          }, 300);
        }, 2000);
      }

      // Update tree view after editing
      function updateTreeView() {
        if (jsonData) {
          const viewer = document.getElementById("jsonViewer");
          if (viewer) {
            viewer.innerHTML = renderJsonTree(jsonData);
          }
        }
      }

      // Update text view after editing
      function updateTextView() {
        if (jsonData) {
          const output = document.getElementById("outputJson");
          if (output) {
            const formattedJson = js_beautify(JSON.stringify(jsonData), {
              indent_size: 2,
              space_in_empty_paren: true,
            });
            output.value = formattedJson;
          }
        }
      }

      // Hide actions when clicking elsewhere
      document.addEventListener("click", (e) => {
        if (!e.target.closest(".json-value-container")) {
          document
            .querySelectorAll(".json-actions")
            .forEach((el) => el.classList.remove("show"));
        }
      });

      // Utility functions
      function countKeys(obj, count = 0) {
        if (typeof obj === "object" && obj !== null) {
          if (Array.isArray(obj)) {
            obj.forEach((item) => (count = countKeys(item, count)));
          } else {
            count += Object.keys(obj).length;
            Object.values(obj).forEach(
              (value) => (count = countKeys(value, count))
            );
          }
        }
        return count;
      }

      function clearInput() {
        const inputJson = document.getElementById("inputJson");
        const inputStatus = document.getElementById("inputStatus");
        const inputLength = document.getElementById("inputLength");

        if (inputJson) inputJson.value = "";

        // Clear localStorage
        try {
          localStorage.removeItem("vscode-persian-copilot-json");
          console.log("üóëÔ∏è JSON cleared from localStorage");
        } catch (e) {
          console.error("‚ùå Failed to clear localStorage:", e);
        }

        clearOutput();
        if (inputStatus) {
          inputStatus.textContent = "ÿ¢ŸÖÿßÿØŸá ÿØÿ±€åÿßŸÅÿ™ JSON...";
          inputStatus.className = "status-info";
        }
        if (inputLength) inputLength.textContent = "0 ⁄©ÿßÿ±ÿß⁄©ÿ™ÿ±";
      }

      function clearOutput() {
        const outputJson = document.getElementById("outputJson");
        const jsonViewer = document.getElementById("jsonViewer");
        const outputStatus = document.getElementById("outputStatus");
        const jsonInfo = document.getElementById("jsonInfo");

        if (outputJson) outputJson.value = "";
        if (jsonViewer) jsonViewer.innerHTML = "";
        if (outputStatus) {
          outputStatus.textContent = "ÿ¢ŸÖÿßÿØŸá ŸÜŸÖÿß€åÿ¥...";
          outputStatus.className = "status-info";
        }
        if (jsonInfo) jsonInfo.textContent = "";
        jsonData = null;
      }

      function copyOutput() {
        if (!jsonData) return;

        const text = beautifyJson(jsonData);

        navigator.clipboard.writeText(text).then(() => {
          const btn = event.target.closest(".icon-btn");
          const originalContent = btn.innerHTML;
          btn.innerHTML = '<span class="material-icons">check</span>';
          setTimeout(() => (btn.innerHTML = originalContent), 1000);
        });
      }

      function downloadJson() {
        if (!jsonData) return;

        const text = beautifyJson(jsonData);

        const blob = new Blob([text], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "data.json";
        a.click();
        URL.revokeObjectURL(url);
      }

      function importFile() {
        const fileInput = document.getElementById("fileInput");
        const inputJson = document.getElementById("inputJson");
        if (!fileInput || !inputJson) return;

        const file = fileInput.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          const content = e.target.result;
          inputJson.value = content;

          // Save imported JSON to localStorage
          saveJsonToStorage(content);

          processJson();
        };
        reader.readAsText(file);
      }

      function loadSample() {
        const sample = {
          user: {
            id: 12345,
            name: "ÿßÿ≠ŸÖÿØ ÿ±ÿ∂ÿß€å€å",
            email: "ahmad@example.com",
            age: 28,
            isActive: true,
            address: {
              street: "ÿÆ€åÿßÿ®ÿßŸÜ ÿ¢ÿ≤ÿßÿØ€å",
              city: "ÿ™Ÿáÿ±ÿßŸÜ",
              country: "ÿß€åÿ±ÿßŸÜ",
              zipCode: "1234567890",
            },
            skills: ["JavaScript", "Python", "React", "Node.js"],
            projects: [
              {
                name: "Ÿàÿ®‚Äåÿ≥ÿß€åÿ™ ŸÅÿ±Ÿàÿ¥⁄ØÿßŸá€å",
                status: "completed",
                year: 2023,
              },
              {
                name: "ÿßŸæŸÑ€å⁄©€åÿ¥ŸÜ ŸÖŸàÿ®ÿß€åŸÑ",
                status: "in-progress",
                year: 2024,
              },
            ],
          },
          metadata: {
            version: "1.0",
            lastUpdated: "2024-01-15T10:30:00Z",
            source: "API",
          },
        };

        const inputJson = document.getElementById("inputJson");
        if (inputJson) {
          const sampleJsonString = JSON.stringify(sample, null, 2);
          inputJson.value = sampleJsonString;

          // Save sample to localStorage
          saveJsonToStorage(sampleJsonString);

          processJson();
        }
      }

      // Auto-process on page load if there's content
      window.addEventListener("load", () => {
        console.log("üöÄ Page loaded, initializing JSON Parser...");

        // Enhanced js-beautify testing
        function testJsBeautify() {
          console.log("üîç Testing js-beautify availability...");
          const beautifyFunc = getBeautifyFunction();

          if (beautifyFunc) {
            console.log("‚úÖ js-beautify function found!");

            // Test with sample JSON
            try {
              const testJson = '{"name":"ÿ™ÿ≥ÿ™","value":123,"array":[1,2,3]}';
              const formatted = beautifyFunc(testJson, {
                indent_size: 2,
                space_in_empty_paren: false,
                preserve_newlines: true,
                max_preserve_newlines: 2,
              });

              console.log("‚úÖ js-beautify test successful!");
              console.log("üìÑ Sample formatting:");
              console.log(formatted);
              return true;
            } catch (e) {
              console.error("‚ùå js-beautify test failed:", e);
              return false;
            }
          } else {
            console.error(
              "‚ùå js-beautify not found! JSON will use basic formatting."
            );
            return false;
          }
        }

        // Test immediately and retry if needed
        if (!testJsBeautify()) {
          console.log("üîÑ Retrying js-beautify test in 500ms...");
          setTimeout(() => {
            if (!testJsBeautify()) {
              console.log("üîÑ Final retry in 1000ms...");
              setTimeout(testJsBeautify, 1000);
            }
          }, 500);
        }

        // Load saved JSON from localStorage
        const inputEl = document.getElementById("inputJson");
        if (inputEl) {
          const savedJson = loadJsonFromStorage();
          if (savedJson) {
            inputEl.value = savedJson;
            console.log("üîÑ Restored previous JSON from localStorage");
            processJson();
          } else if (inputEl.value.trim()) {
            // Process existing content if any
            processJson();
          }
        }
      });
    </script>
  </body>
</html>
